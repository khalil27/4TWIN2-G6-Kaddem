pipeline {
    agent any
    environment {
        imageName = "kaddem-app"
        imageTag = "1.0"
        registryCredentials = "nexus-credentials"
        registry = "192.168.33.10:8083"
        DOCKER_COMPOSE_VERSION = '1.29.2'
        NEXUS_REPO = "http://192.168.33.10:8083/repository/maven-snapshots/"

    }

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/YosrMekki-4TWIN2-G6']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/khalil27/4TWIN2-G6-Kaddem.git',
                        credentialsId: 'git123'
                    ]]
                ])
            }
        }

        stage('Download Maven') {
            steps {
                sh '''
                    mkdir -p $HOME/maven-local

                    if [ ! -f $HOME/maven-local/bin/mvn ]; then
                        echo " Downloading Maven..."
                        wget https://dlcdn.apache.org/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz
                        tar -xzf apache-maven-3.9.6-bin.tar.gz -C $HOME/maven-local --strip-components=1
                        rm apache-maven-3.9.6-bin.tar.gz
                    fi

                    $HOME/maven-local/bin/mvn -version
                '''
            }
        }

        stage('Build') {
            steps {
                dir('kaddem/kaddem') {
                    sh '$HOME/maven-local/bin/mvn clean package -DskipTests'
                }
            }
        }
        stage('Run Unit Tests') {
                    steps {
                    dir('kaddem/kaddem') {
                        sh 'mvn test'
                        }
                    }
                }

        stage('Install Docker Compose (if needed)') {
            steps {
                sh '''
                    if ! docker-compose --version > /dev/null 2>&1; then
                        echo "üõ† Installing Docker Compose..."
                        sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                        sudo chmod +x /usr/local/bin/docker-compose
                    fi
                    docker-compose --version
                '''
            }
        }

        stage('Build and Run with Docker Compose') {
            steps {
                dir('kaddem/kaddem') {
                    sh '''
                        echo "üîß Building and launching services via Docker Compose"
                        docker-compose down || true
                        docker-compose build
                        docker-compose up -d
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dir('kaddem/kaddem') {
                        sh "docker build -t ${imageName}:${imageTag} ."
                        sh "docker tag ${imageName}:${imageTag} ${registry}/${imageName}:${imageTag}"
                    }
                }
            }
        }


        /*stage('Tag Docker Image for Nexus') {
            steps {
                sh '''
                    echo " Tagging the image for Nexus"
                    docker tag mekkiyosr/kaddem-app:latest ${registry}/kaddem/kaddem-app:latest
                '''
            }
        }*/

        stage('Push to Nexus') {
                steps {
                    withCredentials([usernamePassword(credentialsId: 'nexus-credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                        script {
                            sh """
                                docker login -u $USERNAME -p $PASSWORD ${registry}
                                docker push ${registry}/${imageName}:${imageTag}
                            """
                        }
                    }
                }
            }

        stage('Run application ') {
        steps{
        script {
        docker.withRegistry("http://"+registry, registryCredentials
        ) {
        sh('docker pull $registry/kaddem-app:1.0 ')
        sh('docker-compose up -d ')
        }
        }
        }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool 'scanner'
                    withSonarQubeEnv('SonarQube') {
                        dir('kaddem/kaddem') {
                            sh "${scannerHome}/bin/sonar-scanner"
                        }
                    }
                }
            }
        }

        stage('Package') {
            steps {
                dir('kaddem/kaddem') {
                    sh '$HOME/maven-local/bin/mvn clean package -DskipTests'
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: '**/target/*.jar', allowEmptyArchive: true
        }
        success {
            echo '‚úÖ Pipeline completed successfully.'
        }
        failure {
            echo '‚ùå Pipeline failed. Please check the logs for more information.'
        }
    }
}
